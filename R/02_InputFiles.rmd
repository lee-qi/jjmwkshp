---
title: "Jack Mackerel Assessment Workshop"
subtitle: "Model Input Files"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: journal
    number_sections: yes
  word_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir=here::here())
knitr::opts_chunk$set(warning=F, message=F, eval=F)
```

There are three files required to run the `jjm` assessment. You will need:

1. A `.ctl` file
1. A `.dat` file
1. An executable file

An important thing to note for the input files is that ADMB ignores line breaks. The files are read in linearly, so it doesn't matter (to the executable) if values are separated by a space or by a line break. We often use the line breaks to make the files more readable to the human, but that's not how the software reads it.

# Control File

- Contains the settings for the model

- Files used to run the most recent assessment can be found in `jjm/assessment/config`, or [here](https://github.com/SPRFMO/jjm/tree/master/assessment/config) on the Github site.


## Things to Note
- Stores the name of the data file associated with the control file

- Selectivity sharing vector defines the selectivity patterns of each fleet (fishery and survey)

```{r}
# From the TPL file
# // Matrix of selectivity mappings--row 1 is index of stock
# //  row 2 is type (1=fishery, 2=index) and row 3 is index within that type
# //  e.g., the following for 2 fisheries and 4 indices means that index 3 uses fishery 1 selectivities,
# //         the other fisheries and indices use their own parameterization

# Selectivity sharing vector (number_fisheries + number_surveys)  
#Fsh_1 Fsh_2 Fsh_3 Fsh_4 Srv_1 Srv_2 Srv_3 Srv_4 Srv_5 Srv_6 Srv_7
#N_Chile_Fsh CS_Chile_Fsh FarNorth_Fsh Offshore_Trawl_Fsh Chile_AcousCS Chile_AcousN Chilean_CPUE DEPM Peru_Acoustic Peru_CPUE Offshore_CPUE #  
# 2 3 4 1 2 3 4 5 6 7
1 1 1 1 1 1 1 1 1 1 1
1 1 1 1 2 2 1 2 1 1 1
1 2 3 4 1 2 2 4 3 3 4

```

- For each parameter, we define a prior, a coefficient of variance (CV), and a phase of estimation.
    - Negative phases indicate that the parameter is not estimated in the model

```{r}
#Steepness 
0.65 
300 
-6

#catchability 
1.143881847 0.029045376 0.000159487 0.519171913 0.002284038 0.007987171 0.033884372
12  12  12  12  12  12  12
3  5  3  3  3  4  4  
```


- User defines the years of data used to estimate the stock-recruitment relationship
    - Two types of stock-recruit relationships available: Ricker (Option 1) and Beverton-Holt (Option 2)

- The retro input defines how many years of data to "peel" off for the retrospective analysis


```{r}
#Number of regimes (by stock)
1
#Sr_type 
2  
#AgeError 
0  
#Retro 
0  
#Recruitment sharing matrix (number_stocks, number_regimes)
1
```


- Selectivity changes are defined per fleet

```{r}
# Fishery 1 N Chile  
1  #selectivity type
9  #n_sel_ages
2  #phase sel
1  #curvature penalty
1  #Dome-shape penalty
# Years of selectivity change Fishery 1 N Chile  
36                                                          
1984  1985  1986  1987  1988  1989  1990  1991  1992  1993  1994  1995  1996  1997  1998  1999  2000  2001  2002  2003  2004  2005  2006  2007  2008  2009  2010  2011  2012  2013    2014    2015    2016  2017  2018  2019
0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5
# Initial values for coefficitients at each change (one for every change plus 1)  
# 2 3 4 5 6 7 8 9 10 11 12  
0.2 0.7 1 1 1 1 1 1 1 1 1 1  

```

# Data File

- Contains processed data for the assessment

- Files used to run the most recent assessment can be found in `jjm/assessment/input`, or [here](https://github.com/SPRFMO/jjm/tree/master/assessment/input) on the Github site.

- An annotated accompanying Excel file can be found in `jjm/assessment/data/JM Data files for SC09.xlsx`, or [here](https://github.com/SPRFMO/jjm/blob/master/assessment/data/JM%20Data%20files%20for%20SC09.xlsx).


## Things to Note
- Weight at age is required for every fleet in every year of the model
    - Historically, when the year is updated but not the weight-at-age data (e.g. if the weight at age for a particular fleet is unavailable at the time of the SC), the previous year's data are used.


# Executable File

- Specific to operating systems (`jjms.exe` for Windows, `jjms` for Mac and Linux)

- Stored on the Teams site
    - These are not stored on the Github site for security reasons- many computer viruses are sent around as executable files.

- Source code is found in `jjm/src/jjms.TPL`
    - The `jjm` file is deprecated
    - You can use this file to see exactly how the input files are being read in and used in the assessment model.

- Compiled using AD Model Builder ([ADMB](http://www.admb-project.org/))
    - Instructions for compilation can be found in the [PreWorkshop document](https://southpacificrfmo.sharepoint.com/:u:/r/sites/SPRFMOSC10/Shared%20Documents/Jack%20Mackerel/JJM%20Workshop/Tutorials/PreWorkshop.html?csf=1&web=1&e=6vIvxK)


# Reading and Writing Input Files in R

You can edit the files by hand, or within R. If you're planning to use `jjmR` to read and edit input files, you'll have to start with a model that is already run.


The code here will update the name of the model from `1.00` to `1.01`, and write the new control and data files to the specified `ctlPath` and `datPath` directories respectively.

```{r, eval=T}
library(jjmR)

# ?readJJM
# ?writeJJM

# Assuming we're in the jjm/assessment folder
# path = where control files are stored
# input = where data files are stored
# output = where model output files are stored; default is "results"

mod_current <- readJJM("h1_1.00", path = "config", input = "input")

mod_new <- mod_current

names(mod_new) <- mod_new[[1]]$control$modelName <- "h1_1.01"

mod_new[[1]]$control$dataFile <- paste0("h1_1.01",".dat")

# writeJJM(newmod,datPath="input",ctlPath="config")

```

Examining the jjm object can give you some insight as to what the object contains.

```{r, eval=T}
names(mod_new)

names(mod_new[[1]])

mod_new[[1]]$info

names(mod_new[[1]]$control)

names(mod_new[[1]]$data)

names(mod_new[[1]]$output)
```


# Debugging Tips and Tricks
If you edited the input files and the model seems to be giving nonsensical results, it might be that you've missed number or a line in the input.

# Exercises
- How do the model settings for the single-stock (`h1`) and the two-stock (`h2`) models differ?

- How does the `readJJM` object differ for the two-stock model? You can repeat the above exercise using `h2_1.00`.

